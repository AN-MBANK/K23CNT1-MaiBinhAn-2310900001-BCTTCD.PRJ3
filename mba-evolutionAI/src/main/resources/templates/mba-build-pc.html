<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Xây dựng cấu hình PC - MbaEvolutionAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .bg-glass { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .part-card:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        .sticky-summary { position: sticky; top: 100px; }
        .currency::after { content: " ₫"; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom scrollbar cho Modal */
        #modalList::-webkit-scrollbar { width: 5px; }
        #modalList::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 antialiased relative min-h-screen">

<div class="fixed inset-0 z-[-1]">
    <img src="https://wallpapers.com/images/hd/gaming-setup-background-7mt8184753464154.jpg" class="w-full h-full object-cover opacity-10 blur-sm" />
    <div class="absolute inset-0 bg-gray-950/90"></div>
</div>

<div th:replace="~{fragments/mba-header :: navbar}"></div>

<main class="max-w-7xl mx-auto px-4 py-12">
    <div class="flex flex-col lg:flex-row gap-8">

        <div class="flex-1 space-y-6">
            <h1 class="text-4xl font-black text-white italic tracking-tighter uppercase mb-8">
                <span class="text-blue-500">BUILD</span> YOUR BEAST
            </h1>

            <th:block th:with="items=${ {
                {id: 'CPU', name: 'Bộ vi xử lý (CPU)', color: 'blue'},
                {id: 'MAINBOARD', name: 'Bo mạch chủ (Mainboard)', color: 'purple'},
                {id: 'RAM', name: 'Bộ nhớ (RAM)', color: 'indigo'},
                {id: 'VGA', name: 'Card đồ họa (VGA)', color: 'pink'},
                {id: 'SSD', name: 'Ổ cứng (SSD)', color: 'green'},
                {id: 'PSU', name: 'Nguồn máy tính (PSU)', color: 'yellow'},
                {id: 'CASE', name: 'Vỏ máy tính (Case)', color: 'orange'}
            } }">
                <div th:each="part : ${items}" class="bg-glass rounded-2xl p-6 border border-gray-800 transition hover:border-blue-500/50 part-card">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <div th:class="'w-14 h-14 rounded-2xl flex items-center justify-center bg-' + ${part.color} + '-600/20 text-' + ${part.color} + '-500 shadow-lg'">
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v4M11 3v4M15 3v4M17 7h4M17 11h4M17 15h4M3 7h4M3 11h4M3 15h4M7 17v4M11 17v4M15 17v4"/></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg" th:text="${part.name}"></h3>
                                <p th:id="'display-' + ${part.id}" class="text-sm text-gray-500 italic">Chưa chọn sản phẩm</p>
                            </div>
                        </div>
                        <button type="button"
                                th:data-category="${part.id}"
                                onclick="openPartModal(this.getAttribute('data-category'))"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-2xl font-black text-xs transition uppercase tracking-widest shadow-lg shadow-blue-500/20">
                            Chọn
                        </button>
                    </div>
                </div>
            </th:block>
        </div>

        <div class="w-full lg:w-96">
            <div class="bg-glass rounded-3xl p-8 border border-gray-800 sticky-summary shadow-2xl">
                <h2 class="text-xl font-black text-white mb-6 uppercase tracking-widest border-b border-gray-800 pb-4 italic">Cấu hình chi tiết</h2>

                <div id="selectedList" class="space-y-4 mb-8 min-h-[300px]">
                    <p class="text-sm text-gray-500 text-center py-20 italic">Hệ thống đang chờ bạn chọn linh kiện...</p>
                </div>

                <div class="border-t border-gray-800 pt-6">
                    <div class="flex justify-between items-end mb-6">
                        <span class="text-gray-400 font-bold uppercase text-[10px] tracking-widest">Tổng chi phí:</span>
                        <span id="totalPriceDisplay" class="text-3xl font-black text-blue-400 currency">0</span>
                    </div>

                    <form th:action="@{/build-pc/add-to-cart}" method="POST" id="buildForm">
                        <input type="hidden" name="CPU" id="input-CPU">
                        <input type="hidden" name="MAINBOARD" id="input-MAINBOARD">
                        <input type="hidden" name="RAM" id="input-RAM">
                        <input type="hidden" name="VGA" id="input-VGA">
                        <input type="hidden" name="SSD" id="input-SSD">
                        <input type="hidden" name="PSU" id="input-PSU">
                        <input type="hidden" name="CASE" id="input-CASE">

                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 py-5 rounded-2xl font-black text-white hover:scale-[1.02] active:scale-95 transition shadow-xl shadow-blue-500/20 uppercase tracking-tighter">
                            Thêm bộ PC vào giỏ hàng
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="partModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="closeModal()"></div>
    <div class="bg-gray-900 border border-gray-800 w-full max-w-2xl rounded-3xl p-8 relative z-10 shadow-2xl animate-fade-in">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h3 id="modalTitle" class="text-2xl font-black text-white uppercase italic tracking-tighter">Chọn Linh Kiện</h3>
                <div class="h-1 w-12 bg-blue-600 mt-1"></div>
            </div>
            <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center bg-gray-800 rounded-full text-gray-400 hover:text-white transition text-2xl">&times;</button>
        </div>
        <div id="modalList" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2">
        </div>
    </div>
</div>

<div th:replace="~{fragments/mba-footer :: footer}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Nhận dữ liệu từ Spring Boot Controller
    const allParts = {
        'CPU': [[${cpus}]],
        'MAINBOARD': [[${mains}]],
        'RAM': [[${rams}]],
        'VGA': [[${vgas}]],
        'SSD': [[${ssds}]],
        'PSU': [[${psus}]],
        'CASE': [[${cases}]]
    };

    let buildConfig = {};

    function openPartModal(category) {
        const modal = document.getElementById('partModal');
        const list = document.getElementById('modalList');
        document.getElementById('modalTitle').innerText = 'DANH SÁCH ' + category;

        const parts = allParts[category] || [];

        if (parts.length === 0) {
            list.innerHTML = `<div class="text-center py-10"><p class="text-gray-500 italic">Không tìm thấy sản phẩm ${category} nào trong kho.</p></div>`;
        } else {
            list.innerHTML = parts.map(p => `
                <div class="flex justify-between items-center p-4 bg-gray-800/40 rounded-2xl border border-gray-700/50 hover:bg-gray-800/80 transition group">
                    <div class="flex items-center gap-5">
                        <div class="w-16 h-16 bg-white rounded-xl p-2 flex items-center justify-center">
                            <img src="${p.mbaImage}" class="w-full h-full object-contain">
                        </div>
                        <div>
                            <p class="text-white font-bold group-hover:text-blue-400 transition">${p.mbaName}</p>
                            <p class="text-blue-500 font-black text-sm uppercase">${p.mbaPrice.toLocaleString()} ₫</p>
                        </div>
                    </div>
                    <button onclick="confirmSelection('${category}', ${p.mbaProductId}, '${p.mbaName.replace(/'/g, "\\'")}', ${p.mbaPrice})"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-xl font-bold text-xs transition-all shadow-lg shadow-blue-500/10">
                        CHỌN
                    </button>
                </div>
            `).join('');
        }
        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('partModal').classList.add('hidden');
    }

    function confirmSelection(category, id, name, price) {
        // 1. Lưu vào object
        buildConfig[category] = { id, name, price };

        // 2. Gán ID vào input ẩn của Form
        document.getElementById('input-' + category).value = id;

        // 3. Thay đổi text hiển thị ở list bên trái
        const display = document.getElementById('display-' + category);
        display.innerText = name;
        display.className = "text-sm text-blue-400 font-bold not-italic animate-fade-in";

        // 4. Cập nhật bảng tổng kết bên phải
        renderSummary();
        closeModal();
    }

    function renderSummary() {
        const container = document.getElementById('selectedList');
        let total = 0;
        let html = '';

        for (let key in buildConfig) {
            const item = buildConfig[key];
            total += item.price;
            html += `
                <div class="flex justify-between items-center p-4 bg-gray-800/30 rounded-2xl border border-gray-700/50 animate-fade-in">
                    <div class="text-[10px]">
                        <p class="text-gray-500 font-black uppercase tracking-widest">${key}</p>
                        <p class="text-xs text-white font-bold line-clamp-1">${item.name}</p>
                    </div>
                    <span class="text-blue-400 font-black text-xs">${item.price.toLocaleString()}đ</span>
                </div>`;
        }

        container.innerHTML = html || '<p class="text-sm text-gray-500 text-center py-20 italic">Hệ thống đang chờ bạn chọn linh kiện...</p>';
        document.getElementById('totalPriceDisplay').innerText = total.toLocaleString();
    }
    /*]]>*/
</script>
</body>
</html>